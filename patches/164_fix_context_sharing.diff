From: Alan Hourihane <alanh@tungstengraphics.com>
Date: Wed, 27 Feb 2008 16:49:34 +0000 (+0000)
Subject: Fix context sharing between direct/indirect contexts
X-Git-Tag: xf-3_9_16Z / xf-3_9_16d / xf-3_9_16e / xf-3_9_16f
X-Git-Url: http://gitweb.freedesktop.org/?p=xorg/xserver.git;a=commitdiff;h=a65d4aed06acd839fb21153f74144498abda3e18

Fix context sharing between direct/indirect contexts
---

Index: xorg-server/GL/glx/glxdri.c
===================================================================
--- xorg-server.orig/GL/glx/glxdri.c	2008-04-09 11:10:49.000000000 +0300
+++ xorg-server/GL/glx/glxdri.c	2008-04-09 11:10:49.000000000 +0300
@@ -617,6 +617,9 @@
     else
 	sharePrivate = NULL;
 
+    if (baseShareContext && baseShareContext->isDirect)
+        return NULL;
+
     context = xalloc(sizeof *context);
     if (context == NULL)
 	return NULL;
@@ -636,6 +639,11 @@
 					   0, /* render type */
 					   sharePrivate,
 					   &context->driContext);
+    
+    if (!context->driContext.private) {
+    	xfree(context);
+    	return NULL;
+    }
 
     context->driContext.mode = modes;
 
